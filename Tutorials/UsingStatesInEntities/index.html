---
title: Working With Glue Entities
layout: tutorial
tagline: This tutorial builds on the previous entities tutorial by making use of an advanced Glue topic states. In it, you will learn how to apply states to your Glue Entity in order to simplify setting the proper animation for a character.
description: This tutorial builds on the previous entities tutorial by making use of an advanced Glue topic states. In it, you will learn how to apply states to your Glue Entity in order to simplify setting the proper animation for a character.
---

<div class="tutorialinstruction">
    This tutorial builds on the <a href="../WorkingWithEntities/">previous entities tutorial</a> by making use of an advanced Glue topic: <a target="_blank" href="http://documentation.flatredball.com/frb/docs/index.php?title=Glue:Tutorials:States">States.</a> In it, you will learn how to apply states to your Glue Entity in order to simplify setting the proper animation for a character.
</div>

<div class="tutorialinstruction">
    <p>In the <a href="../WorkingWithEntities/">previous</a> tutorial, you learned how to load an existing Spriter animation into a Glue Entity, and with some simple keyboard input code, you played a walk left and right animation, plus idle. In this tutorial, we will expand on the concept by using States in glue. It is my hope that you start to see the true power of using Glue to load Spriter animations.
    </p>
    <p>Since we will be starting at the end of the previous tutorial, please make sure you have an entity with a Spriter animation loaded, and an ObjectInstance object that is a SpriterObject. If you did the previous tutorial, that is where you are, so open that project in Glue at this time.</p>
</div>

<div class="tutorialinstruction">
    <h4>Adding states</h4>
    <p>Open your GreyGuy entity, right click on States, and click Add State Category:</p>
    <img class="tutorialimg" src="images/addcategory.PNG"/>
    <p>Call it AnimationState</p>
</div>

<div class="tutorialinstruction">
    <p>Now expand States, right click on the AnimationState folder, and click Add State:</p>
    <img class="tutorialimg" src="images/addstate.PNG"/>
    <p>Call it WalkingLeft.</p>
    <p>Repeat this process until you have the following States added:</p>
    <ul>
        <li>WalkingLeft</li>
        <li>WalkingRight</li>
        <li>Crouching</li>
        <li>Jumping</li>
        <li>Idle</li>
    </ul>
</div>

<div class="tutorialinstruction">
    <h4>Add a variable with event for AnimationState</h4>
    <p>That created an enumeration. Now we need a variable and events for the current AnimationState GreyGuy is in.</p>
    <p>Right Click Variables, add Variable, and select to expose an existing variable CurrentAnimationStateState:</p>
    <img class="tutorialimg" src="images/addvariable.PNG"/>
    <p>Now select the Variable in the list of Variables, and in the property grid, change CreatesEvent to True:</p>
    <img class="tutorialimg" src="images/createsevent.PNG"/>
</div>

<div class="tutorialinstruction">
    <h4>Now expose two events</h4>
    <p>We have a variable that you can set on GreyGuy, but we need to know when it changes. That is where events come in.</p>
    <p>Right click on Events, and Add Event:</p>
    <img class="tutorialimg" src="images/addevent.PNG"/>
    <p>Choose to expose an existing event, and select AfterCurrentAnimationStateStateSet:</p>
    <img class="tutorialimg" src="images/exposeevent.PNG"/>
    <p>Repeat this and add an event for BeforeCurrentAnimationStateStateSet as well.</p>
</div>


<div class="tutorialinstruction">
    <h4>Now we're ready to code!</h4>
    <p>So, we have everything we need to fire up an animation, set some events, and get this guy running around, jumping, and crouching!</p>
    <p>Open up the project in Visual Studio (Project menu in Glue is a quick way to do this.)</p>
    <p>Replace the CustomActivity function in your GreyGuy entity with the following code:</p>
    {% highlight C# %}if (!InputManager.Keyboard.KeyDown(Keys.Right) && !InputManager.Keyboard.KeyDown(Keys.Left))
{
    Velocity.X = 0f;
}
if (InputManager.Keyboard.KeyPushed(Keys.Right))
{
    Velocity.X = 250f;
}
if (InputManager.Keyboard.KeyPushed(Keys.Left))
{
    Velocity.X = -250f;
}

if (Velocity.X == 0f && !InputManager.Keyboard.KeyDown(Keys.Up) && !InputManager.Keyboard.KeyDown(Keys.Down))
{
    CurrentAnimationStateState = AnimationState.Idle;
}
else if (Velocity.X < 0f && ObjectInstance.CurrentAnimation.Name != "walk")
{
    CurrentAnimationStateState = AnimationState.WalkingLeft;
}
else if (Velocity.X > 0f && ObjectInstance.CurrentAnimation.Name != "walk")
{
    CurrentAnimationStateState = AnimationState.WalkingRight;
}
else if (Velocity.X == 0f && ObjectInstance.CurrentAnimation.Name != "crouch_down" &&
            InputManager.Keyboard.KeyDown(Keys.Down))
{
    CurrentAnimationStateState = AnimationState.Crouching;
}
else if (ObjectInstance.CurrentAnimation.Name != "jump_start" && ObjectInstance.CurrentAnimation.Name != "jump_loop" && InputManager.Keyboard.KeyDown(Keys.Up))
{
    CurrentAnimationStateState = AnimationState.Jumping;
}{% endhighlight %}
</div>

<div class="tutorialinstruction">
    <p>Now look for GreyGuy.Event.cs, and make it look like this:</p>
{% highlight C# %}private Action<SpriterObjectAnimation> _jumpstartfinished = null;
private AnimationState _previousAnimationState;
void OnAfterCurrentAnimationStateStateSet(object sender, EventArgs e)
{
    var state = CurrentAnimationStateState;
    if (_previousAnimationState != CurrentAnimationStateState)
    {
        switch (state)
        {
            case AnimationState.Idle:
                ObjectInstance.StartAnimation("idle");
                break;
            case AnimationState.WalkingLeft:
            case AnimationState.WalkingRight:
                ObjectInstance.StartAnimation("walk");
                break;
            case AnimationState.Crouching:
                ObjectInstance.StartAnimation("crouch_down");
                break;
            case AnimationState.Jumping:
                ObjectInstance.StartAnimation("jump_start");
                if (_jumpstartfinished == null)
                {
                    _jumpstartfinished = animation =>
                    {
                        ObjectInstance.AnimationFinished -= _jumpstartfinished;
                        if (CurrentAnimationStateState == AnimationState.Jumping)
                        {
                            ObjectInstance.StartAnimation("jump_loop");
                        }
                    };
                }
                ObjectInstance.AnimationFinished += _jumpstartfinished;
                break;
        }
    }
}

void OnBeforeCurrentAnimationStateStateSet(object sender, EventArgs e)
{
    _previousAnimationState = CurrentAnimationStateState;
    }{% endhighlight %}
    <p>You're probably going to have to add a using statement too:</p>
    {% highlight C# %}using FlatRedBall_Spriter;{% endhighlight %}
</div>

<div class="tutorialinstruction">
    <p>If you fire up the game now, you'll be able to walk around, jump, and crouch!</p>
    <p>You will notice that the GreyGuy is moonwalking if you walk left, and we can fix that easily right from within Glue!</p>
    <p>Right click on Variables, and add a new variable. Tunnel a variable from ObjectInstance called FlipHorizontal:</p>
    <img src="images/fliphorizontalvariable.PNG" class="tutorialimg"/>
</div>

<div class="tutorialinstruction">
    <p>Now that you have a variable on GreyGuy for FlipHorizontal, States in Glue can see it, so go to the WalkingLeft state, and make sure it sets ObjectInstanceFlipHorizontal to true:</p>
    <img class="tutorialimg" src="images/walkleftflip.PNG"/>
    <p>Do the same for WalkingRight, but set it to false:</p>
    <img class="tutorialimg" src="images/walkrightflip.PNG"/>
    <p>Now when you run the game, changing to the WalkingLeft state will cause the FlipHorizontal property (via the Variable tunnel) to change to true, therefore causing the SpriterObject to flip the animation!</p>
</div>

<div class="tutorialinstruction">
    <p>That's it! I hope you can see now the power of Glue and Spriter combined! More tutorials to come, so keep checking!</p>
</div>